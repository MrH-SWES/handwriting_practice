<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Handwriting Journal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://db.onlinewebfonts.com/c/39fb6851b2f2f38e273a81a5dc9d91d0?family=Teaching+Print+Dotted+Lined" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f0f4f8; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        h1 { text-align: center; color: #2c3e50; margin-bottom: 5px; }
        .teacher-header { text-align: center; color: #2196F3; margin-bottom: 25px; font-size: 1.4em; font-weight: bold; }
        
        /* Name Input Section */
        .name-section { background: #e8f5e9; padding: 25px; border-radius: 10px; margin-bottom: 20px; text-align: center; border: 2px solid #c8e6c9; }
        .name-section label { display: block; margin-bottom: 10px; font-weight: bold; font-size: 1.2em; color: #2e7d32; }
        .name-section input { width: 80%; padding: 12px; font-size: 18px; border: 2px solid #a5d6a7; border-radius: 8px; text-align: center; outline: none; }
        
        /* Main Interface */
        .panel h2 { color: #555; margin-bottom: 15px; font-size: 1.2em; }
        textarea { width: 100%; min-height: 250px; padding: 15px; font-size: 20px; border: 2px solid #ddd; border-radius: 8px; resize: vertical; font-family: Arial, sans-serif; line-height: 1.6; background-color: #fafafa; }
        
        /* Buttons */
        button { padding: 14px 24px; font-size: 18px; border: none; border-radius: 8px; cursor: pointer; transition: transform 0.1s; width: 100%; margin-bottom: 12px; font-weight: bold; }
        button:active { transform: scale(0.98); }
        .send-btn { background-color: #2196F3; color: white; }
        .send-btn:hover { background-color: #1976D2; }
        .send-btn:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        .preview-btn { background-color: #4CAF50; color: white; margin-bottom: 20px; }
        .clear-btn { background-color: #FF9800; color: white; width: auto; font-size: 14px; padding: 8px 16px; margin-top: 10px; float: right; }
        
        /* Mic Button Styles */
        .mic-btn { 
            background-color: #f44336; /* Red for recording */
            color: white; 
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .mic-btn:hover { background-color: #d32f2f; }
        .mic-btn.listening { 
            animation: pulse 1.5s infinite; 
            background-color: #ff1744;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(244, 67, 54, 0); }
            100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
        }

        /* Preview */
        .preview-area { margin-top: 20px; padding: 20px; border: 3px dashed #b0bec5; border-radius: 10px; min-height: 120px; font-family: 'Teaching Print Dotted Lined'; font-size: 60px; line-height: 1.8; background: white; word-wrap: break-word; display:none; }
        .font-preload { font-family: 'Teaching Print Dotted Lined'; position: absolute; left: -9999px; visibility: hidden; }
        
        /* Status */
        .status { text-align: center; padding: 15px; margin-top: 15px; border-radius: 8px; font-weight: bold; display: none; }
        .status.info { background-color: #e3f2fd; color: #1565c0; display: block; }
        .status.error { background-color: #ffebee; color: #c62828; display: block; }
        .status.success { background-color: #e8f5e9; color: #2e7d32; display: block; }
    </style>
</head>
<body>
    <div class="font-preload">ABCabc123</div>
    
    <div class="container">
        <h1>üìù Handwriting Journal</h1>
        <div id="classHeader" class="teacher-header">Loading Class...</div>
        
        <div id="nameSection" class="name-section">
            <label for="studentName">What's your name?</label>
            <input type="text" id="studentName" placeholder="Type your name here..." autocomplete="off">
            <button onclick="saveName()" class="send-btn" style="margin-top: 20px; width: auto;">Start Writing</button>
        </div>

        <div id="mainInterface" style="display: none;">
            <p style="margin-bottom: 15px;">Student: <strong id="displayStudent" style="color: #2196F3;"></strong></p>
            
            <div class="panel">
                <button id="micBtn" class="mic-btn" onclick="toggleDictation()">
                    <span>üé§</span> <span id="micStatus">Tap to Speak</span>
                </button>

                <textarea id="journalInput" placeholder="Tap the mic or type here..." oninput="updatePreview()"></textarea>
                <button id="clearBtn" class="clear-btn">Clear Text</button>
                <div style="clear: both;"></div>
            </div>

            <button class="preview-btn" onclick="updatePreview()">üëÅ Preview Handwriting</button>
            <div id="previewArea" class="preview-area"></div>
            
            <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
            
            <button id="sendBtn" class="send-btn" onclick="sendToTeacher()">üì§ Send to Teacher</button>
        </div>
        
        <div id="status" class="status"></div>
    </div>

    <script>
        const { jsPDF } = window.jspdf;
        
        // ==========================================
        // CONFIGURATION
        // ==========================================
        
        const TEACHER_NAME = "Ms. Karlie"; 
        const TEACHER_EMAIL = "khutson@sw.wednet.edu";
        const CENTRAL_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyrfCdgct4_U3XfbdRUBmt-0PiGCaXu08M4RK6lV4QFs1CnGFEuJoOIQ8YyitouoP0G/exec"; 
        
        // ==========================================

        document.getElementById('classHeader').textContent = TEACHER_NAME + "'s Class";
        let studentName = '';

        // Name Logic
        window.onload = function() {
            const saved = localStorage.getItem('studentName_journal');
            if (saved) document.getElementById('studentName').value = saved;
        };

        function saveName() {
            const val = document.getElementById('studentName').value.trim();
            if (!val) { showStatus('Please enter your name.', 'error'); return; }
            studentName = val;
            localStorage.setItem('studentName_journal', studentName);
            document.getElementById('nameSection').style.display = 'none';
            document.getElementById('mainInterface').style.display = 'block';
            document.getElementById('displayStudent').textContent = studentName;
            document.getElementById('sendBtn').textContent = "üì§ Send to " + TEACHER_NAME;
            showStatus('', 'none');
        }

        // Font Loading
        document.fonts.ready.then(() => {
            if (!document.fonts.check('48px "Teaching Print Dotted Lined"')) {
                const font = new FontFace('Teaching Print Dotted Lined', 'url(https://db.onlinewebfonts.com/t/39fb6851b2f2f38e273a81a5dc9d91d0.woff2) format("woff2")');
                font.load().then(f => document.fonts.add(f));
            }
        });

        /* =========================================
           SMART DICTATION LOGIC
           ========================================= */
        let recognition;
        let isListening = false;

        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true; 
            recognition.lang = 'en-US';        

            recognition.onstart = function() {
                isListening = true;
                document.getElementById('micBtn').classList.add('listening');
                document.getElementById('micStatus').textContent = "Listening... (Tap to Stop)";
            };

            recognition.onend = function() {
                isListening = false;
                document.getElementById('micBtn').classList.remove('listening');
                document.getElementById('micStatus').textContent = "Tap to Speak";
            };

            recognition.onresult = function(event) {
                let finalTranscript = '';
                
                // Loop through results to separate interim from final
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    }
                }

                if (finalTranscript) {
                    const input = document.getElementById('journalInput');
                    let previousText = input.value;
                    
                    // Add space if needed
                    if (previousText && !previousText.endsWith(' ') && !previousText.endsWith('\n')) {
                        previousText += ' ';
                    }
                    
                    let newText = previousText + finalTranscript;
                    input.value = cleanUpText(newText);
                    updatePreview(); 
                }
            };
        } else {
            document.getElementById('micBtn').style.display = 'none';
            console.log("Web Speech API not supported.");
        }

        function toggleDictation() {
            if (!recognition) { alert("Speech recognition not supported on this browser."); return; }
            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        }

        // Basic Grammar Cleanup Function
        function cleanUpText(text) {
            // Capitalize 'i' alone
            text = text.replace(/\bi\b/g, 'I');
            // Capitalize 'i'm' -> "I'm"
            text = text.replace(/\bi'm\b/g, "I'm");
            
            // Capitalize first letter of string
            if(text.length > 0) {
                text = text.charAt(0).toUpperCase() + text.slice(1);
            }

            // Capitalize after punctuation (. ? !)
            text = text.replace(/([.!?]\s+)([a-z])/g, function(match, separator, char) {
                return separator + char.toUpperCase();
            });

            // Remove double spaces
            text = text.replace(/\s+/g, ' ');

            return text;
        }

        // =========================================
        // PDF & PREVIEW LOGIC
        // =========================================

        function updatePreview() {
            const text = document.getElementById('journalInput').value;
            const preview = document.getElementById('previewArea');
            if (text.trim()) {
                preview.style.display = 'block';
                preview.textContent = text;
            } else {
                preview.style.display = 'none';
            }
        }

        async function createPDF(text) {
            await document.fonts.ready;
            await new Promise(r => setTimeout(r, 100));
            
            const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
            const w = pdf.internal.pageSize.getWidth();
            const h = pdf.internal.pageSize.getHeight();
            
            const canvas = document.createElement('canvas');
            const scale = 3; 
            canvas.width = w * scale; canvas.height = h * scale;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = 'white'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'black'; ctx.textBaseline = 'top';
            const fontSize = 56 * scale;
            ctx.font = fontSize + 'px "Teaching Print Dotted Lined"';
            
            const marginLeft = 40 * scale; const marginTop = 60 * scale;
            const maxWidth = canvas.width - (marginLeft * 2); const lineHeight = fontSize * 2.0;
            
            let y = marginTop;
            for (const paragraph of text.split('\n')) {
                if (!paragraph.trim()) { y += lineHeight * 0.5; continue; }
                const words = paragraph.split(' ');
                let line = '';
                for (const word of words) {
                    const test = line + (line ? ' ' : '') + word;
                    if (ctx.measureText(test).width > maxWidth && line) {
                        ctx.fillText(line, marginLeft, y);
                        line = word; y += lineHeight;
                        if (y > canvas.height - marginTop) {
                            pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, w, h);
                            pdf.addPage();
                            ctx.fillStyle = 'white'; ctx.fillRect(0, 0, canvas.width, canvas.height);
                            ctx.fillStyle = 'black'; ctx.font = fontSize + 'px "Teaching Print Dotted Lined"';
                            y = marginTop;
                        }
                    } else { line = test; }
                }
                if (line) { ctx.fillText(line, marginLeft, y); y += lineHeight; }
            }
            pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, w, h);
            return pdf.output('datauristring');
        }

        async function sendToTeacher() {
            if (CENTRAL_SCRIPT_URL.includes('PASTE_YOUR')) {
                showStatus('Error: Setup incomplete. Script URL missing.', 'error'); return;
            }
            const text = document.getElementById('journalInput').value.trim();
            if (!text) { showStatus('Please write something first!', 'error'); return; }

            const btn = document.getElementById('sendBtn');
            btn.disabled = true; btn.textContent = '‚è≥ Sending...';
            
            try {
                showStatus('Generating PDF...', 'info');
                const pdfData = await createPDF(text);
                
                showStatus('Emailing ' + TEACHER_NAME + '...', 'info');
                const today = new Date().toISOString().split('T')[0];
                
                const payload = {
                    filename: `${studentName}_Journal_${today}.pdf`,
                    targetEmail: TEACHER_EMAIL,
                    filedata: pdfData
                };

                await fetch(CENTRAL_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                
                showStatus('‚úÖ Sent Successfully!', 'success');
                btn.textContent = 'Sent!';
                setTimeout(() => { btn.disabled = false; btn.textContent = "üì§ Send to " + TEACHER_NAME; }, 5000);

            } catch (error) {
                console.error(error);
                showStatus('Error: ' + error.message, 'error');
                btn.disabled = false;
            }
        }

        document.getElementById('clearBtn').addEventListener('click', () => {
            if(confirm('Clear text?')) {
                document.getElementById('journalInput').value = '';
                document.getElementById('previewArea').style.display = 'none';
            }
        });

        function showStatus(msg, type) {
            const s = document.getElementById('status');
            s.textContent = msg; s.className = 'status ' + type;
            if(type === 'none') s.style.display = 'none'; else s.style.display = 'block';
        }
    </script>
</body>
</html>
