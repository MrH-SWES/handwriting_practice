<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Journal to Handwriting Practice</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @font-face {
            font-family: 'TracingFont';
            src: url('https://willwade.github.io/HandwritingFonts/fonts/TeachingPrintDottedLined.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
            font-display: block;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; margin-bottom: 30px; }
        .auth-section { background: #f0f8ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        .auth-section.hidden { display: none; }
        .panel { margin-bottom: 20px; }
        .panel h2 { color: #555; margin-bottom: 15px; font-size: 1.3em; }
        textarea { width: 100%; min-height: 300px; padding: 15px; font-size: 18px; border: 2px solid #ddd; border-radius: 5px; resize: vertical; font-family: Arial, sans-serif; line-height: 1.6; }
        button { padding: 12px 24px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; width: 100%; margin-bottom: 10px; }
        .send-btn { background-color: #2196F3; color: white; }
        .send-btn:hover { background-color: #0b7dda; }
        .send-btn:disabled { background-color: #ccc; cursor: not-allowed; }
        .clear-btn { background-color: #ff9800; color: white; }
        .clear-btn:hover { background-color: #e68900; }
        .status { text-align: center; padding: 10px; margin-top: 10px; border-radius: 5px; font-weight: bold; }
        .status.info { background-color: #e3f2fd; color: #1976d2; }
        .status.error { background-color: #ffebee; color: #c62828; }
        .status.success { background-color: #e8f5e9; color: #2e7d32; }
        .font-preload { font-family: 'TracingFont'; position: absolute; left: -9999px; visibility: hidden; font-size: 48px; }
    </style>
</head>
<body>
    <div class="font-preload">ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789</div>
    <div class="container">
        <h1>üìù Handwriting Journal</h1>
        <div id="authSection" class="auth-section">
            <h3>Step 1: Sign in with your school Google account</h3>
            <p style="margin: 10px 0; color: #666;">You only need to do this once!</p>
            <button onclick="initializeGoogleAuth()" class="send-btn" style="width: auto; padding: 12px 32px;">Sign in with Google</button>
        </div>
        <div id="mainInterface" style="display: none;">
            <div class="panel">
                <h2>Type or Dictate Your Journal</h2>
                <p style="color: #666; margin-bottom: 10px;">Use Chromebook dictation: Press Search + D</p>
                <textarea id="journalInput" placeholder="Type your journal entry here..."></textarea>
            </div>
            <button id="sendBtn" class="send-btn">üìß Send to Teacher</button>
            <button id="clearBtn" class="clear-btn">Clear</button>
        </div>
        <div id="status"></div>
    </div>
    <script>
        const { jsPDF } = window.jspdf;
        let accessToken = null;
        let fontLoaded = false;
        const TEACHER_EMAIL = 'mgriffiths@sw.wednet.edu';
        const CLIENT_ID = '783305028308-h84fgomb3hdcjjgs323c0dp4n16f4j0g.apps.googleusercontent.com';

        async function loadTracingFont() {
            try {
                const font = new FontFace('TracingFont', "url('https://willwade.github.io/HandwritingFonts/fonts/TeachingPrintDottedLined.otf')");
                await font.load();
                document.fonts.add(font);
                fontLoaded = true;
                console.log('TracingFont loaded successfully');
                return true;
            } catch (error) {
                console.error('Error loading font:', error);
                await document.fonts.ready;
                fontLoaded = true;
                return true;
            }
        }

        loadTracingFont();

        function initializeGoogleAuth() {
            google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/drive.file',
                callback: (response) => {
                    if (response.access_token) {
                        accessToken = response.access_token;
                        document.getElementById('authSection').classList.add('hidden');
                        document.getElementById('mainInterface').style.display = 'block';
                        showStatus('Signed in successfully!', 'success');
                    }
                },
            }).requestAccessToken();
        }

        async function createPDF(text) {
            if (!fontLoaded) await loadTracingFont();
            await document.fonts.ready;
            
            const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            
            const canvas = document.createElement('canvas');
            const scale = 3;
            canvas.width = pageWidth * scale;
            canvas.height = pageHeight * scale;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'black';
            ctx.textBaseline = 'top';
            
            const fontSize = 48 * scale;
            ctx.font = fontSize + 'px TracingFont';
            
            const marginLeft = 40 * scale;
            const marginTop = 60 * scale;
            const maxWidth = canvas.width - (marginLeft * 2);
            const lineHeight = fontSize * 1.8;
            
            let y = marginTop;
            const paragraphs = text.split('\n');
            
            for (const paragraph of paragraphs) {
                if (paragraph.trim() === '') { y += lineHeight * 0.5; continue; }
                const words = paragraph.split(' ');
                let line = '';
                for (const word of words) {
                    const testLine = line + (line ? ' ' : '') + word;
                    const metrics = ctx.measureText(testLine);
                    if (metrics.width > maxWidth && line) {
                        ctx.fillText(line, marginLeft, y);
                        line = word;
                        y += lineHeight;
                        if (y > canvas.height - marginTop) {
                            pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, pageWidth, pageHeight);
                            pdf.addPage();
                            ctx.fillStyle = 'white';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                            ctx.fillStyle = 'black';
                            ctx.font = fontSize + 'px TracingFont';
                            y = marginTop;
                        }
                    } else { line = testLine; }
                }
                if (line) { ctx.fillText(line, marginLeft, y); y += lineHeight; }
            }
            
            pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, pageWidth, pageHeight);
            return pdf.output('blob');
        }

        async function sendToTeacher() {
            const text = document.getElementById('journalInput').value.trim();
            if (!text) { showStatus('Please enter some text first.', 'error'); return; }
            if (!accessToken) { showStatus('Please sign in first.', 'error'); return; }
            
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;

            try {
                showStatus('Creating PDF with handwriting font...', 'info');
                const pdfBlob = await createPDF(text);
                
                showStatus('Uploading to Google Drive...', 'info');
                const metadata = { name: 'Handwriting_Practice_' + new Date().toISOString().split('T')[0] + '.pdf', mimeType: 'application/pdf' };
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', pdfBlob);

                const uploadResponse = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + accessToken },
                    body: form
                });

                if (!uploadResponse.ok) {
                    const errorData = await uploadResponse.json();
                    throw new Error(errorData.error?.message || 'Failed to upload to Google Drive');
                }

                const fileData = await uploadResponse.json();
                const fileId = fileData.id;

                await fetch('https://www.googleapis.com/drive/v3/files/' + fileId + '/permissions', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + accessToken, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role: 'reader', type: 'anyone' })
                });

                const driveLink = 'https://drive.google.com/file/d/' + fileId + '/view';
                const subject = 'Handwriting Practice Journal';
                const body = encodeURIComponent('Here is my handwriting practice:\n\n' + driveLink + '\n\n(Click the link to view and download the PDF)');
                
                window.open('https://mail.google.com/mail/?view=cm&fs=1&to=' + TEACHER_EMAIL + '&su=' + subject + '&body=' + body, '_blank');
                showStatus('Success! Email window opened.', 'success');
                
            } catch (error) {
                console.error('Error:', error);
                showStatus('Error: ' + error.message, 'error');
            } finally {
                sendBtn.disabled = false;
            }
        }

        document.getElementById('sendBtn').addEventListener('click', sendToTeacher);
        document.getElementById('clearBtn').addEventListener('click', () => {
            document.getElementById('journalInput').value = '';
            showStatus('Cleared.', 'info');
        });

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + type;
            if (type !== 'success' && type !== 'info') {
                setTimeout(() => { statusDiv.textContent = ''; statusDiv.className = 'status'; }, 5000);
            }
        }
    </script>
</body>
</html>
